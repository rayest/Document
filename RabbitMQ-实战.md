# 天降奇兵

* 消息队列使用消息将应用程序连接起来，RabbitMQ 作为消息代理服务器在程序之间路由，似邮局
* AMQP：高级消息队列协议

## 运行

* ```bash
  $ cd /usr/local/Cellar/rabbitmq/3.7.4/sbin
  $ rabbitmq-server
  $ rabbitmqctl status
  ```

* 用户和密码：admin、admin（代码里会用到）

# 理解消息通信

* AMQP 为离线消费存储消息，这些消息没有固定的结构，解耦通信，隐去了消息的发送方和接收方
* 可以一对多或者一对一的路由进行程序间的通信
* 消息分为有效负荷和标签，rabbit 根据标签决定将消息发送给接收方。发后即忘
* 通信之前先建立信道 channel。在应用程序和rabbit之间创建 tcp 连接，然后创建一条信道
*   AMQP 的命令都是在信道中发送出去的，可以在一个TCP连接上创建成千上万的信道，而不会影响操作系统

## 队列

* AMQP 消息路由有三个部分：交换器、队列、绑定
* 生产者将消息发送到交换器上并被消费者接收，绑定决定了消息如何从路由器路由到特定的队列
* 当有至少一个消费者订阅了队列的话，消息会立即发送给这些订阅的消费者
* 无人订阅时，消息会在队列中等待，直到有消费者订阅时，立即发送之
* 多个消费者时，队列将消息以循环的方式依次将消息发送给消费者，每个消息只会发送给其中的一个消费者，消费者需要向 rabbitMQ 额外的确认
* 创建队列
  * 若消费者在同一个信道上订阅了另一个队列，就无法再申明新队列了，必须先取消订阅，将信道置为传输模式
  * 创建和订阅时都需指定队列的名称，创建绑定时也需要指定队列的名称，如不指定则会被随机分配一个

## 交换器和绑定

* 消息到达队列时，需要将消息发送给交换器来完成，然后根据规则决定消息会投递到哪个队列，这些规则称为路由键
* 队列通过路由键绑定到交换器，且交换器有4种类型，分别有不同的路由算法
* direct
  * 如果路由键匹配的话，就将消息投递到对应的队列
* fanout
  * 将收到的消息广播到绑定的队列上。即当一条消息到达fanout交换器时，会把消息投递到所有附加在该交换器的队列上
  * 亦即若某一个交换器附加了若干个队列 ( 这些队列用以处理不同的业务 )，当一条消息先到达交换器时，交换器会将该条消息投递给上述的几个队列中
* topic
  * 可以使得来自不同源头的消息能够达到同一个队列
* headers
  * 几乎不会用到。略去